{% extends 'base.html' %}
{% load static %}

{% block title %}Admin Dashboard - SmartShop BD{% endblock %}

{% block content %}
<style>
    /* ===== PROFESSIONAL E-COMMERCE ADMIN DASHBOARD ===== */
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap');
    
    * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
    }
    
    .admin-dashboard {
        font-family: 'Inter', sans-serif;
        background: #f8fafc;
        min-height: 100vh;
    }
    
    /* ===== ADMIN LAYOUT ===== */
    .admin-wrapper {
        display: grid;
        grid-template-columns: 280px 1fr;
        min-height: 100vh;
    }
    
    /* ===== SIDEBAR - PROFESSIONAL DARK THEME ===== */
    .admin-sidebar {
        background: #0B2B40;
        color: white;
        padding: 30px 20px;
        position: sticky;
        top: 0;
        height: 100vh;
        overflow-y: auto;
        box-shadow: 4px 0 20px rgba(0,0,0,0.08);
    }
    
    .admin-logo {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 0 10px 30px 10px;
        border-bottom: 1px solid rgba(255,255,255,0.1);
        margin-bottom: 30px;
    }
    
    .admin-logo i {
        font-size: 32px;
        color: #FFEAA7;
    }
    
    .admin-logo span {
        font-size: 20px;
        font-weight: 700;
        color: white;
    }
    
    .admin-logo small {
        display: block;
        font-size: 11px;
        color: rgba(255,255,255,0.6);
        font-weight: 400;
        margin-top: 2px;
    }
    
    .admin-user-card {
        background: rgba(255,255,255,0.05);
        border-radius: 16px;
        padding: 20px;
        margin-bottom: 30px;
        display: flex;
        align-items: center;
        gap: 15px;
        border: 1px solid rgba(255,255,255,0.1);
    }
    
    .admin-avatar {
        width: 55px;
        height: 55px;
        background: linear-gradient(135deg, #2C7A7B, #1E5F6B);
        border-radius: 14px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 22px;
        font-weight: 700;
        color: #FFEAA7;
    }
    
    .admin-user-info h5 {
        font-size: 16px;
        font-weight: 700;
        color: white;
        margin-bottom: 4px;
    }
    
    .admin-user-info p {
        font-size: 12px;
        color: rgba(255,255,255,0.7);
    }
    
    .admin-menu-title {
        font-size: 12px;
        text-transform: uppercase;
        letter-spacing: 1.5px;
        color: rgba(255,255,255,0.5);
        font-weight: 700;
        padding: 0 15px;
        margin-bottom: 15px;
    }
    
    .admin-menu {
        list-style: none;
        padding: 0;
        margin: 0 0 30px 0;
    }
    
    .admin-menu-item {
        margin-bottom: 5px;
    }
    
    .admin-menu-link {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 12px 18px;
        border-radius: 12px;
        color: rgba(255,255,255,0.8);
        font-weight: 500;
        font-size: 14px;
        text-decoration: none;
        transition: all 0.2s;
    }
    
    .admin-menu-link i {
        font-size: 18px;
        width: 24px;
        color: rgba(255,255,255,0.6);
    }
    
    .admin-menu-link:hover {
        background: rgba(255,255,255,0.08);
        color: white;
    }
    
    .admin-menu-link:hover i {
        color: #FFEAA7;
    }
    
    .admin-menu-link.active {
        background: #2C7A7B;
        color: white;
    }
    
    .admin-menu-link.active i {
        color: white;
    }
    
    .admin-menu-badge {
        margin-left: auto;
        background: rgba(255,255,255,0.15);
        padding: 2px 10px;
        border-radius: 50px;
        font-size: 11px;
        font-weight: 600;
        color: white;
    }
    
    /* ===== MAIN CONTENT ===== */
    .admin-main {
        background: #f8fafc;
        padding: 30px;
        overflow-y: auto;
    }
    
    .admin-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 30px;
    }
    
    .admin-header-left h1 {
        font-size: 28px;
        font-weight: 700;
        color: #0B2B40;
        margin-bottom: 8px;
    }
    
    .admin-breadcrumb {
        display: flex;
        align-items: center;
        gap: 8px;
        color: #64748b;
        font-size: 14px;
    }
    
    .admin-breadcrumb i {
        font-size: 12px;
    }
    
    .admin-header-right {
        display: flex;
        align-items: center;
        gap: 20px;
    }
    
    .admin-notification {
        position: relative;
    }
    
    .admin-notification i {
        font-size: 24px;
        color: #475569;
        cursor: pointer;
    }
    
    .notification-badge {
        position: absolute;
        top: -5px;
        right: -5px;
        background: #E53E3E;
        color: white;
        font-size: 11px;
        font-weight: 700;
        padding: 2px 6px;
        border-radius: 50px;
    }
    
    .admin-date {
        background: white;
        padding: 10px 20px;
        border-radius: 50px;
        font-size: 14px;
        font-weight: 500;
        color: #334155;
        border: 1px solid #e2e8f0;
    }
    
    /* ===== STATS CARDS ===== */
    .stats-grid {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 24px;
        margin-bottom: 30px;
    }
    
    .stat-card {
        background: white;
        border-radius: 20px;
        padding: 24px;
        box-shadow: 0 5px 20px rgba(0,0,0,0.01);
        border: 1px solid #edf2f7;
        display: flex;
        align-items: center;
        justify-content: space-between;
        transition: all 0.3s;
    }
    
    .stat-card:hover {
        transform: translateY(-4px);
        box-shadow: 0 20px 30px rgba(44,122,123,0.08);
        border-color: #b2d8d9;
    }
    
    .stat-info h4 {
        font-size: 14px;
        color: #64748b;
        margin-bottom: 8px;
        font-weight: 600;
    }
    
    .stat-number {
        font-size: 32px;
        font-weight: 800;
        color: #0B2B40;
        margin-bottom: 4px;
    }
    
    .stat-trend {
        font-size: 12px;
        color: #10b981;
        display: flex;
        align-items: center;
        gap: 4px;
    }
    
    .stat-icon {
        width: 60px;
        height: 60px;
        background: linear-gradient(135deg, #0B2B40, #1A4A5F);
        border-radius: 18px;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    
    .stat-icon i {
        font-size: 28px;
        color: #FFEAA7;
    }
    
    /* ===== CHARTS SECTION ===== */
    .charts-row {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 24px;
        margin-bottom: 30px;
    }
    
    .chart-card {
        background: white;
        border-radius: 20px;
        padding: 24px;
        border: 1px solid #edf2f7;
    }
    
    .chart-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
    }
    
    .chart-header h3 {
        font-size: 16px;
        font-weight: 700;
        color: #0B2B40;
        display: flex;
        align-items: center;
        gap: 10px;
    }
    
    .chart-period {
        padding: 6px 14px;
        border-radius: 50px;
        background: #f1f5f9;
        color: #475569;
        font-size: 13px;
        font-weight: 600;
    }
    
    .chart-placeholder {
        width: 100%;
        height: 250px;
        display: flex;
        align-items: flex-end;
        gap: 16px;
        padding-top: 20px;
    }
    
    .chart-bar-group {
        flex: 1;
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 8px;
    }
    
    .chart-bar {
        width: 100%;
        background: linear-gradient(to top, #0B2B40, #2C7A7B);
        border-radius: 8px 8px 4px 4px;
        height: 0;
        transition: height 0.3s;
    }
    
    .chart-label {
        font-size: 12px;
        color: #64748b;
        font-weight: 600;
    }
    
    /* ===== RECENT ORDERS ===== */
    .recent-orders {
        background: white;
        border-radius: 20px;
        padding: 24px;
        border: 1px solid #edf2f7;
        margin-bottom: 30px;
    }
    
    .section-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 24px;
    }
    
    .section-header h3 {
        font-size: 18px;
        font-weight: 700;
        color: #0B2B40;
        display: flex;
        align-items: center;
        gap: 10px;
    }
    
    .view-all {
        color: #2C7A7B;
        text-decoration: none;
        font-weight: 600;
        font-size: 14px;
        display: flex;
        align-items: center;
        gap: 6px;
    }
    
    .orders-table {
        width: 100%;
        border-collapse: collapse;
    }
    
    .orders-table th {
        text-align: left;
        padding: 14px 12px;
        font-size: 12px;
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        color: #64748b;
        border-bottom: 2px solid #e2e8f0;
    }
    
    .orders-table td {
        padding: 16px 12px;
        font-size: 14px;
        color: #334155;
        border-bottom: 1px solid #edf2f7;
    }
    
    .order-id {
        font-weight: 700;
        color: #0B2B40;
    }
    
    .customer-cell {
        display: flex;
        align-items: center;
        gap: 10px;
    }
    
    .customer-avatar {
        width: 36px;
        height: 36px;
        background: #f1f5f9;
        border-radius: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 700;
        color: #0B2B40;
    }
    
    .customer-info {
        display: flex;
        flex-direction: column;
    }
    
    .customer-name {
        font-weight: 600;
        color: #0B2B40;
    }
    
    .customer-email {
        font-size: 12px;
        color: #64748b;
    }
    
    /* Location/Address Styles */
    .location-cell {
        max-width: 200px;
    }
    
    .location-details {
        font-size: 13px;
        color: #475569;
        display: flex;
        align-items: flex-start;
        gap: 6px;
    }
    
    .location-details i {
        color: #2C7A7B;
        font-size: 14px;
        margin-top: 2px;
        flex-shrink: 0;
    }
    
    .location-text {
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }
    
    .location-full {
        display: none;
        position: absolute;
        background: white;
        border: 1px solid #e2e8f0;
        border-radius: 8px;
        padding: 8px 12px;
        box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        z-index: 100;
        font-size: 13px;
        max-width: 300px;
        white-space: normal;
        word-wrap: break-word;
    }
    
    .location-details:hover .location-full {
        display: block;
    }
    
    .status-badge {
        display: inline-block;
        padding: 6px 14px;
        border-radius: 50px;
        font-size: 12px;
        font-weight: 700;
    }
    
    .status-pending {
        background: #fff3cd;
        color: #856404;
    }
    
    .status-confirmed {
        background: #d1ecf1;
        color: #0c5460;
    }
    
    .status-packed {
        background: #cce5ff;
        color: #004085;
    }
    
    .status-shipped {
        background: #d4edda;
        color: #155724;
    }
    
    .status-delivered {
        background: #d1e7dd;
        color: #0f5132;
    }
    
    .status-cancelled {
        background: #f8d7da;
        color: #721c24;
    }
    
    .payment-badge {
        display: inline-block;
        padding: 4px 10px;
        border-radius: 50px;
        font-size: 11px;
        font-weight: 700;
    }
    
    .payment-paid {
        background: #d1e7dd;
        color: #0f5132;
    }
    
    .payment-unpaid {
        background: #f8d7da;
        color: #721c24;
    }
    
    .action-buttons {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
    }
    
    .btn-action {
        padding: 6px 14px;
        border-radius: 8px;
        font-size: 12px;
        font-weight: 600;
        border: none;
        cursor: pointer;
        transition: all 0.2s;
        display: inline-flex;
        align-items: center;
        gap: 6px;
    }
    
    .btn-confirm {
        background: #d1e7dd;
        color: #0f5132;
    }
    
    .btn-confirm:hover {
        background: #0f5132;
        color: white;
    }
    
    .btn-verify {
        background: #cce5ff;
        color: #004085;
    }
    
    .btn-verify:hover {
        background: #004085;
        color: white;
    }
    
    .btn-cancel {
        background: #f8d7da;
        color: #721c24;
    }
    
    .btn-cancel:hover {
        background: #721c24;
        color: white;
    }
    
    .btn-view {
        background: #e2e8f0;
        color: #334155;
    }
    
    .btn-view:hover {
        background: #334155;
        color: white;
    }
    
    .btn-payment {
        background: #cce5ff;
        color: #004085;
    }
    
    .btn-payment:hover {
        background: #004085;
        color: white;
    }
    
    /* ===== PAYMENT VERIFICATION SECTION ===== */
    .payment-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 20px;
        margin-bottom: 30px;
    }
    
    .payment-card {
        background: white;
        border: 1px solid #edf2f7;
        border-radius: 16px;
        padding: 20px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        transition: all 0.2s;
    }
    
    .payment-card:hover {
        border-color: #2C7A7B;
        box-shadow: 0 8px 20px rgba(44,122,123,0.06);
    }
    
    .payment-info h4 {
        font-size: 16px;
        font-weight: 700;
        color: #0B2B40;
        margin-bottom: 8px;
    }
    
    .payment-details {
        font-size: 13px;
        color: #64748b;
        margin-bottom: 4px;
    }
    
    .payment-amount {
        font-size: 22px;
        font-weight: 800;
        color: #0B2B40;
        margin-bottom: 10px;
    }
    
    /* ===== PRODUCT TABLE ===== */
    .product-filters {
        display: flex;
        gap: 12px;
        margin-bottom: 20px;
    }
    
    .product-search {
        flex: 1;
        padding: 12px 20px;
        border: 1px solid #e2e8f0;
        border-radius: 12px;
        font-size: 14px;
    }
    
    .btn-add {
        background: #0B2B40;
        color: white;
        border: none;
        padding: 12px 24px;
        border-radius: 12px;
        font-weight: 700;
        display: flex;
        align-items: center;
        gap: 8px;
        cursor: pointer;
    }
    
    .btn-add:hover {
        background: #1A4A5F;
    }
    
    .stock-badge {
        display: inline-block;
        padding: 4px 12px;
        border-radius: 50px;
        font-size: 12px;
        font-weight: 600;
    }
    
    .stock-high {
        background: #d1e7dd;
        color: #0f5132;
    }
    
    .stock-medium {
        background: #fff3cd;
        color: #856404;
    }
    
    .stock-low {
        background: #f8d7da;
        color: #721c24;
    }
    
    /* ===== RESPONSIVE ===== */
    @media (max-width: 1200px) {
        .stats-grid {
            grid-template-columns: repeat(2, 1fr);
        }
        
        .charts-row {
            grid-template-columns: 1fr;
        }
    }
    
    @media (max-width: 992px) {
        .admin-wrapper {
            grid-template-columns: 1fr;
        }
        
        .admin-sidebar {
            display: none;
        }
        
        .admin-main {
            padding: 20px;
        }
    }
    
    @media (max-width: 768px) {
        .stats-grid {
            grid-template-columns: 1fr;
        }
        
        .payment-grid {
            grid-template-columns: 1fr;
        }
        
        .orders-table {
            display: block;
            overflow-x: auto;
        }
    }
    
    /* ===== LOADING SPINNER ===== */
    .loading-spinner {
        display: inline-block;
        width: 20px;
        height: 20px;
        border: 3px solid rgba(255,255,255,0.3);
        border-radius: 50%;
        border-top-color: white;
        animation: spin 1s ease-in-out infinite;
    }
    
    @keyframes spin {
        to { transform: rotate(360deg); }
    }
    
    /* ===== TOAST NOTIFICATION ===== */
    .toast-notification {
        position: fixed;
        top: 20px;
        right: 20px;
        background: white;
        border-radius: 12px;
        padding: 16px 24px;
        box-shadow: 0 10px 40px rgba(0,0,0,0.1);
        border-left: 6px solid #2C7A7B;
        z-index: 9999;
        animation: slideIn 0.3s ease;
        max-width: 400px;
    }
    
    .toast-success {
        border-left-color: #10b981;
    }
    
    .toast-error {
        border-left-color: #ef4444;
    }
    
    @keyframes slideIn {
        from {
            transform: translateX(100%);
            opacity: 0;
        }
        to {
            transform: translateX(0);
            opacity: 1;
        }
    }
</style>

<!-- ===== ADMIN ONLY ACCESS CHECK ===== -->
{% if not user.is_authenticated or not user.is_staff %}
<script>
    // Redirect non-admin users to home page
    window.location.href = "{% url 'home' %}";
</script>
{% else %}

<!-- ===== PROFESSIONAL ADMIN DASHBOARD - REAL DATA ===== -->
<div class="admin-dashboard">
    <div class="admin-wrapper">
        <!-- ===== SIDEBAR ===== -->
        <div class="admin-sidebar">
            <div class="admin-logo">
                <i class="bi bi-shop"></i>
                <div>
                    <span>SmartShop BD</span>
                    <small>E-Commerce Admin</small>
                </div>
            </div>
            
            <div class="admin-user-card">
                <div class="admin-avatar">{{ user.username|first|upper }}</div>
                <div class="admin-user-info">
                    <h5>{{ user.get_full_name|default:user.username }}</h5>
                    <p>{{ user.email }}</p>
                </div>
            </div>
            
            <div class="admin-menu-title">MAIN NAVIGATION</div>
            <ul class="admin-menu">
                <li class="admin-menu-item">
                    <a href="#dashboard" class="admin-menu-link active" data-section="dashboard">
                        <i class="bi bi-speedometer2"></i>
                        Dashboard
                    </a>
                </li>
                <li class="admin-menu-item">
                    <a href="#orders" class="admin-menu-link" data-section="orders">
                        <i class="bi bi-truck"></i>
                        Orders Management
                        <span class="admin-menu-badge" id="pending-orders-badge">{{ pending_orders }}</span>
                    </a>
                </li>
                <li class="admin-menu-item">
                    <a href="#payments" class="admin-menu-link" data-section="payments">
                        <i class="bi bi-credit-card"></i>
                        Payment Verification
                        <span class="admin-menu-badge" id="pending-payments-badge">{{ pending_payments }}</span>
                    </a>
                </li>
                <li class="admin-menu-item">
                    <a href="#products" class="admin-menu-link" data-section="products">
                        <i class="bi bi-box-seam"></i>
                        Products
                    </a>
                </li>
                <li class="admin-menu-item">
                    <a href="#categories" class="admin-menu-link" data-section="categories">
                        <i class="bi bi-grid"></i>
                        Categories
                    </a>
                </li>
                <li class="admin-menu-item">
                    <a href="#customers" class="admin-menu-link" data-section="customers">
                        <i class="bi bi-people"></i>
                        Customers
                        <span class="admin-menu-badge">{{ total_customers }}</span>
                    </a>
                </li>
                <li class="admin-menu-item">
                    <a href="#reports" class="admin-menu-link" data-section="reports">
                        <i class="bi bi-bar-chart"></i>
                        Reports
                    </a>
                </li>
            </ul>
            
            <div class="admin-menu-title">SETTINGS</div>
            <ul class="admin-menu">
                <li class="admin-menu-item">
                    <a href="#profile" class="admin-menu-link" data-section="profile">
                        <i class="bi bi-person-circle"></i>
                        Admin Profile
                    </a>
                </li>
                <li class="admin-menu-item">
                    <a href="{% url 'logout' %}" class="admin-menu-link">
                        <i class="bi bi-box-arrow-right"></i>
                        Logout
                    </a>
                </li>
            </ul>
        </div>
        
        <!-- ===== MAIN CONTENT ===== -->
        <div class="admin-main" id="adminContent">
            <!-- Dashboard Section (Default View) -->
            <div id="dashboard-section">
                <!-- Header -->
                <div class="admin-header">
                    <div class="admin-header-left">
                        <h1>Dashboard Overview</h1>
                        <div class="admin-breadcrumb">
                            <i class="bi bi-house"></i> Home
                            <i class="bi bi-chevron-right"></i>
                            Dashboard
                        </div>
                    </div>
                    <div class="admin-header-right">
                        <div class="admin-notification">
                            <i class="bi bi-bell"></i>
                            <span class="notification-badge">{{ pending_orders|add:pending_payments }}</span>
                        </div>
                        <div class="admin-date">
                            <i class="bi bi-calendar3"></i>
                            {{ current_date }}
                        </div>
                    </div>
                </div>
                
                <!-- Stats Cards - REAL DATA -->
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-info">
                            <h4>Total Orders</h4>
                            <div class="stat-number">{{ total_orders }}</div>
                            <div class="stat-trend">
                                <i class="bi bi-arrow-up"></i> {{ sales_trend }}%
                            </div>
                        </div>
                        <div class="stat-icon">
                            <i class="bi bi-truck"></i>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-info">
                            <h4>Total Revenue</h4>
                            <div class="stat-number">৳{{ total_revenue|floatformat:0 }}</div>
                            <div class="stat-trend">
                                <i class="bi bi-arrow-up"></i> This Month
                            </div>
                        </div>
                        <div class="stat-icon">
                            <i class="bi bi-currency-dollar"></i>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-info">
                            <h4>Products</h4>
                            <div class="stat-number">{{ total_products }}</div>
                            <div class="stat-trend">
                                <i class="bi bi-exclamation-triangle"></i> {{ low_stock_products }} low stock
                            </div>
                        </div>
                        <div class="stat-icon">
                            <i class="bi bi-box-seam"></i>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-info">
                            <h4>Customers</h4>
                            <div class="stat-number">{{ total_customers }}</div>
                            <div class="stat-trend">
                                <i class="bi bi-arrow-up"></i> Active
                            </div>
                        </div>
                        <div class="stat-icon">
                            <i class="bi bi-people"></i>
                        </div>
                    </div>
                </div>
                
                <!-- Charts - REAL DATA -->
                <div class="charts-row">
                    <div class="chart-card">
                        <div class="chart-header">
                            <h3><i class="bi bi-graph-up"></i> Sales Analytics</h3>
                            <span class="chart-period">This Week</span>
                        </div>
                        <div class="chart-placeholder" id="sales-chart">
                            {% for sale in sales_data %}
                            <div class="chart-bar-group">
                                <div class="chart-bar" style="height: {% widthratio sale max_sales 200 %}px;"></div>
                                <span class="chart-label">{{ days_labels|slice:forloop.counter0|first }}</span>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                    <div class="chart-card">
                        <div class="chart-header">
                            <h3><i class="bi bi-pie-chart"></i> Payment Methods</h3>
                            <span class="chart-period">Distribution</span>
                        </div>
                        <div style="display: flex; align-items: center; justify-content: center; height: 250px; gap: 40px;">
                            <div style="text-align: center;">
                                <div style="font-size: 48px; color: #0B2B40;">{{ bkash_percent }}%</div>
                                <div style="display: flex; align-items: center; gap: 8px; margin-top: 10px;">
                                    <span style="width: 12px; height: 12px; background: #0B2B40; border-radius: 3px;"></span>
                                    <span>bKash</span>
                                </div>
                            </div>
                            <div style="text-align: center;">
                                <div style="font-size: 48px; color: #2C7A7B;">{{ nagad_percent }}%</div>
                                <div style="display: flex; align-items: center; gap: 8px; margin-top: 10px;">
                                    <span style="width: 12px; height: 12px; background: #2C7A7B; border-radius: 3px;"></span>
                                    <span>Nagad</span>
                                </div>
                            </div>
                            <div style="text-align: center;">
                                <div style="font-size: 48px; color: #1A4A5F;">{{ rocket_percent }}%</div>
                                <div style="display: flex; align-items: center; gap: 8px; margin-top: 10px;">
                                    <span style="width: 12px; height: 12px; background: #1A4A5F; border-radius: 3px;"></span>
                                    <span>Rocket</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Recent Orders - REAL DATA -->
                <div class="recent-orders">
                    <div class="section-header">
                        <h3><i class="bi bi-clock-history"></i> Recent Orders</h3>
                        <a href="#orders" class="view-all" onclick="document.querySelector('[data-section=orders]').click(); return false;">
                            View All Orders
                            <i class="bi bi-arrow-right"></i>
                        </a>
                    </div>
                    
                    <div class="table-responsive">
                        <table class="orders-table">
                            <thead>
                                <tr>
                                    <th>Order ID</th>
                                    <th>Customer</th>
                                    <th>Location</th>
                                    <th>Date</th>
                                    <th>Amount</th>
                                    <th>Payment</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="recent-orders-table-body">
                                {% for order in recent_orders %}
                                <tr id="order-row-{{ order.id }}">
                                    <td><span class="order-id">#ORD-{{ order.id }}</span></td>
                                    <td>
                                        <div class="customer-cell">
                                            <div class="customer-avatar">{{ order.user.username|first|upper }}</div>
                                            <div class="customer-info">
                                                <span class="customer-name">{{ order.user.get_full_name|default:order.user.username }}</span>
                                                <span class="customer-email">{{ order.user.email }}</span>
                                            </div>
                                        </div>
                                    </td>
                                    <td class="location-cell">
                                        <div class="location-details">
                                            <i class="bi bi-geo-alt-fill"></i>
                                            <span class="location-text">
                                                {% with profile=order.user.userprofile %}
                                                    {{ profile.address|default:"No address"|truncatechars:30 }}
                                                {% endwith %}
                                            </span>
                                            <div class="location-full">
                                                {% with profile=order.user.userprofile %}
                                                    <strong>Address:</strong> {{ profile.address|default:"Not provided" }}<br>
                                                    <strong>Phone:</strong> {{ profile.phone|default:"Not provided" }}
                                                {% endwith %}
                                            </div>
                                        </div>
                                    </td>
                                    <td>{{ order.created_at|date:"d M Y" }}</td>
                                    <td>৳{{ order.total_price|add:60 }}</td>
                                    <td>
                                        {% if order.payment_status %}
                                        <span class="payment-badge payment-paid">{{ order.get_payment_method_display }}</span>
                                        {% else %}
                                        <span class="payment-badge payment-unpaid">{{ order.get_payment_method_display }}</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <span class="status-badge status-{{ order.order_status }}">{{ order.get_order_status_display }}</span>
                                    </td>
                                    <td>
                                        <div class="action-buttons">
                                            {% if not order.payment_status and order.payment_method != 'cod' %}
                                                <button class="btn-action btn-payment" onclick="verifyPayment({{ order.id }})">
                                                    <i class="bi bi-check-circle"></i> Verify
                                                </button>
                                            {% endif %}
                                            {% if order.order_status == 'pending' %}
                                                <button class="btn-action btn-confirm" onclick="confirmOrder({{ order.id }})">
                                                    <i class="bi bi-check2"></i> Confirm
                                                </button>
                                            {% endif %}
                                            {% if order.order_status == 'confirmed' %}
                                                <button class="btn-action btn-view" onclick="updateStatus({{ order.id }}, 'packed')">
                                                    <i class="bi bi-box"></i> Pack
                                                </button>
                                            {% endif %}
                                            {% if order.order_status == 'packed' %}
                                                <button class="btn-action btn-view" onclick="updateStatus({{ order.id }}, 'shipped')">
                                                    <i class="bi bi-truck"></i> Ship
                                                </button>
                                            {% endif %}
                                            {% if order.order_status == 'shipped' %}
                                                <button class="btn-action btn-confirm" onclick="updateStatus({{ order.id }}, 'delivered')">
                                                    <i class="bi bi-check2-circle"></i> Deliver
                                                </button>
                                            {% endif %}
                                            {% if order.order_status != 'delivered' and order.order_status != 'cancelled' %}
                                                <button class="btn-action btn-cancel" onclick="cancelOrder({{ order.id }})">
                                                    <i class="bi bi-x-circle"></i>
                                                </button>
                                            {% endif %}
                                            <button class="btn-action btn-view" onclick="viewOrderDetails({{ order.id }})">
                                                <i class="bi bi-eye"></i>
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                                {% empty %}
                                <tr>
                                    <td colspan="8" style="text-align: center; padding: 40px;">
                                        <i class="bi bi-inbox" style="font-size: 48px; color: #cbd5e0;"></i>
                                        <p style="margin-top: 16px; color: #64748b;">No orders found</p>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            
            <!-- Orders Management Section - With Customer Location -->
            <div id="orders-section" style="display: none;">
                <div class="admin-header">
                    <div class="admin-header-left">
                        <h1>Orders Management</h1>
                        <div class="admin-breadcrumb">
                            <i class="bi bi-house"></i> Home
                            <i class="bi bi-chevron-right"></i>
                            Orders
                        </div>
                    </div>
                    <div class="admin-header-right">
                        <div class="admin-date" onclick="loadOrders('all')" style="cursor: pointer;">
                            <i class="bi bi-arrow-repeat"></i>
                            Refresh
                        </div>
                    </div>
                </div>
                
                <div style="background: white; border-radius: 20px; padding: 24px; border: 1px solid #edf2f7;">
                    <div style="display: flex; gap: 12px; margin-bottom: 24px; flex-wrap: wrap;">
                        <button class="filter-tab active" style="padding: 10px 20px; border-radius: 50px; border: none; background: #0B2B40; color: white; font-weight: 600;" onclick="loadOrders('all')">All Orders</button>
                        <button class="filter-tab" style="padding: 10px 20px; border-radius: 50px; border: none; background: #f1f5f9; color: #475569; font-weight: 600;" onclick="loadOrders('pending')">Pending</button>
                        <button class="filter-tab" style="padding: 10px 20px; border-radius: 50px; border: none; background: #f1f5f9; color: #475569; font-weight: 600;" onclick="loadOrders('confirmed')">Confirmed</button>
                        <button class="filter-tab" style="padding: 10px 20px; border-radius: 50px; border: none; background: #f1f5f9; color: #475569; font-weight: 600;" onclick="loadOrders('packed')">Packed</button>
                        <button class="filter-tab" style="padding: 10px 20px; border-radius: 50px; border: none; background: #f1f5f9; color: #475569; font-weight: 600;" onclick="loadOrders('shipped')">Shipped</button>
                        <button class="filter-tab" style="padding: 10px 20px; border-radius: 50px; border: none; background: #f1f5f9; color: #475569; font-weight: 600;" onclick="loadOrders('delivered')">Delivered</button>
                        <button class="filter-tab" style="padding: 10px 20px; border-radius: 50px; border: none; background: #f1f5f9; color: #475569; font-weight: 600;" onclick="loadOrders('cancelled')">Cancelled</button>
                    </div>
                    
                    <div class="table-responsive">
                        <table class="orders-table">
                            <thead>
                                <tr>
                                    <th>Order ID</th>
                                    <th>Customer</th>
                                    <th>Location</th>
                                    <th>Phone</th>
                                    <th>Date</th>
                                    <th>Amount</th>
                                    <th>Payment</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="orders-table-body">
                                <tr>
                                    <td colspan="9" style="text-align: center; padding: 40px;">
                                        <div class="loading-spinner" style="border-top-color: #0B2B40;"></div>
                                        <p style="margin-top: 16px; color: #64748b;">Loading orders...</p>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            
            <!-- Payment Verification Section -->
            <div id="payments-section" style="display: none;">
                <div class="admin-header">
                    <div class="admin-header-left">
                        <h1>Payment Verification</h1>
                        <div class="admin-breadcrumb">
                            <i class="bi bi-house"></i> Home
                            <i class="bi bi-chevron-right"></i>
                            Payments
                        </div>
                    </div>
                </div>
                
                <div style="background: white; border-radius: 20px; padding: 24px; border: 1px solid #edf2f7; margin-bottom: 30px;">
                    <h3 style="font-size: 18px; font-weight: 700; color: #0B2B40; margin-bottom: 20px; display: flex; align-items: center; gap: 10px;">
                        <i class="bi bi-hourglass-split"></i> Pending Verifications
                    </h3>
                    
                    <div class="payment-grid" id="pending-payments-grid">
                        {% for payment in pending_payments_list %}
                        <div class="payment-card" id="payment-card-{{ payment.id }}">
                            <div class="payment-info">
                                <h4>#ORD-{{ payment.order.id }} - {{ payment.get_method_display }}</h4>
                                <div class="payment-details">Transaction: {{ payment.transaction_id }}</div>
                                <div class="payment-details">Amount: ৳{{ payment.amount|floatformat:0 }}</div>
                                <div class="payment-details">Time: {{ payment.created_at|date:"d M, h:i A" }}</div>
                            </div>
                            <div>
                                <div class="payment-amount">৳{{ payment.amount|floatformat:0 }}</div>
                                <button class="btn-action btn-verify" style="width: 100%; justify-content: center;" onclick="verifyPayment({{ payment.id }}, {{ payment.order.id }})">
                                    <i class="bi bi-check-circle"></i> Verify Payment
                                </button>
                            </div>
                        </div>
                        {% empty %}
                        <div style="grid-column: 1/-1; text-align: center; padding: 40px;">
                            <i class="bi bi-check2-circle" style="font-size: 48px; color: #cbd5e0;"></i>
                            <p style="margin-top: 16px; color: #64748b;">No pending payments</p>
                        </div>
                        {% endfor %}
                    </div>
                </div>
                
                <div style="background: white; border-radius: 20px; padding: 24px; border: 1px solid #edf2f7;">
                    <h3 style="font-size: 18px; font-weight: 700; color: #0B2B40; margin-bottom: 20px; display: flex; align-items: center; gap: 10px;">
                        <i class="bi bi-check2-circle"></i> Verified Payments
                    </h3>
                    
                    <div class="table-responsive">
                        <table class="orders-table">
                            <thead>
                                <tr>
                                    <th>Order ID</th>
                                    <th>Method</th>
                                    <th>Transaction ID</th>
                                    <th>Amount</th>
                                    <th>Verified By</th>
                                    <th>Verified Date</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for payment in verified_payments %}
                                <tr>
                                    <td>#ORD-{{ payment.order.id }}</td>
                                    <td>{{ payment.get_method_display }}</td>
                                    <td>{{ payment.transaction_id }}</td>
                                    <td>৳{{ payment.amount|floatformat:0 }}</td>
                                    <td>Admin</td>
                                    <td>{{ payment.verified_at|date:"d M Y" }}</td>
                                </tr>
                                {% empty %}
                                <tr>
                                    <td colspan="6" style="text-align: center; padding: 40px;">
                                        <i class="bi bi-inbox" style="font-size: 48px; color: #cbd5e0;"></i>
                                        <p style="margin-top: 16px; color: #64748b;">No verified payments</p>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            
            <!-- Products Management Section -->
            <div id="products-section" style="display: none;">
                <div class="admin-header">
                    <div class="admin-header-left">
                        <h1>Products Management</h1>
                        <div class="admin-breadcrumb">
                            <i class="bi bi-house"></i> Home
                            <i class="bi bi-chevron-right"></i>
                            Products
                        </div>
                    </div>
                    <div class="admin-header-right">
                        <button class="btn-add" onclick="showAddProductModal()">
                            <i class="bi bi-plus-circle"></i> Add New Product
                        </button>
                    </div>
                </div>
                
                <div style="background: white; border-radius: 20px; padding: 24px; border: 1px solid #edf2f7;">
                    <div class="product-filters">
                        <input type="text" class="product-search" id="product-search" placeholder="Search products by name, category..." onkeyup="searchProducts()">
                        <select id="category-filter" style="padding: 12px 24px; border-radius: 12px; border: 1px solid #e2e8f0; background: white;" onchange="searchProducts()">
                            <option value="">All Categories</option>
                            {% for category in categories %}
                            <option value="{{ category.id }}">{{ category.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    
                    <div class="table-responsive">
                        <table class="orders-table">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Product</th>
                                    <th>Category</th>
                                    <th>Price</th>
                                    <th>Stock</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="products-table-body">
                                {% for product in products %}
                                <tr id="product-row-{{ product.id }}">
                                    <td>#P-{{ product.id }}</td>
                                    <td>
                                        <div style="display: flex; align-items: center; gap: 12px;">
                                            {% if product.image %}
                                            <img src="{{ product.image.url }}" style="width: 40px; height: 40px; border-radius: 10px; object-fit: cover;">
                                            {% else %}
                                            <div style="width: 40px; height: 40px; background: #f1f5f9; border-radius: 10px; display: flex; align-items: center; justify-content: center;">
                                                <i class="bi bi-image" style="color: #94a3b8;"></i>
                                            </div>
                                            {% endif %}
                                            {{ product.name }}
                                        </div>
                                    </td>
                                    <td>{{ product.category.name }}</td>
                                    <td>৳{{ product.final_price }}</td>
                                    <td>
                                        <span class="stock-badge 
                                            {% if product.stock > 20 %}stock-high
                                            {% elif product.stock > 5 %}stock-medium
                                            {% else %}stock-low{% endif %}">
                                            {{ product.stock }} units
                                        </span>
                                    </td>
                                    <td>
                                        {% if product.stock > 0 %}
                                        <span class="status-badge status-confirmed">Active</span>
                                        {% else %}
                                        <span class="status-badge status-cancelled">Out of Stock</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <div class="action-buttons">
                                            <button class="btn-action btn-view" onclick="editProduct({{ product.id }})">
                                                <i class="bi bi-pencil"></i> Edit
                                            </button>
                                            <button class="btn-action btn-cancel" onclick="deleteProduct({{ product.id }})">
                                                <i class="bi bi-trash"></i> Delete
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                                {% empty %}
                                <tr>
                                    <td colspan="7" style="text-align: center; padding: 40px;">
                                        <i class="bi bi-box-seam" style="font-size: 48px; color: #cbd5e0;"></i>
                                        <p style="margin-top: 16px; color: #64748b;">No products found</p>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Toast Notification Container -->
<div id="toast-container" style="position: fixed; top: 20px; right: 20px; z-index: 9999;"></div>

<script>
    // ================================================
    // ===== ADMIN DASHBOARD - REAL TIME ACTIONS ======
    // ================================================
    
    // Section Navigation
    document.querySelectorAll('.admin-menu-link[data-section]').forEach(link => {
        link.addEventListener('click', function(e) {
            e.preventDefault();
            
            // Remove active class from all menu items
            document.querySelectorAll('.admin-menu-link').forEach(item => {
                item.classList.remove('active');
            });
            
            // Add active class to clicked item
            this.classList.add('active');
            
            // Get section to show
            const section = this.dataset.section;
            
            // Hide all sections
            document.getElementById('dashboard-section').style.display = 'none';
            document.getElementById('orders-section').style.display = 'none';
            document.getElementById('payments-section').style.display = 'none';
            document.getElementById('products-section').style.display = 'none';
            
            // Show selected section
            if (section === 'dashboard') {
                document.getElementById('dashboard-section').style.display = 'block';
            } else if (section === 'orders') {
                document.getElementById('orders-section').style.display = 'block';
                loadOrders('all');
            } else if (section === 'payments') {
                document.getElementById('payments-section').style.display = 'block';
            } else if (section === 'products') {
                document.getElementById('products-section').style.display = 'block';
            }
        });
    });
    
    // ===== ORDER MANAGEMENT =====
    function confirmOrder(orderId) {
        if (!confirm('Confirm this order?')) return;
        
        fetch(`/admin/orders/${orderId}/confirm/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}',
                'Content-Type': 'application/json'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showToast('success', data.message);
                // Update UI
                const row = document.getElementById(`order-row-${orderId}`);
                if (row) {
                    const statusCell = row.querySelector('.status-badge');
                    statusCell.className = 'status-badge status-confirmed';
                    statusCell.textContent = 'Confirmed';
                    
                    // Update action buttons
                    const actionsCell = row.querySelector('.action-buttons');
                    actionsCell.innerHTML = `
                        <button class="btn-action btn-view" onclick="updateStatus(${orderId}, 'packed')">
                            <i class="bi bi-box"></i> Pack
                        </button>
                        <button class="btn-action btn-cancel" onclick="cancelOrder(${orderId})">
                            <i class="bi bi-x-circle"></i>
                        </button>
                        <button class="btn-action btn-view" onclick="viewOrderDetails(${orderId})">
                            <i class="bi bi-eye"></i>
                        </button>
                    `;
                }
                // Update pending orders badge
                updateBadges();
            } else {
                showToast('error', data.message);
            }
        })
        .catch(error => {
            showToast('error', 'Error confirming order');
        });
    }
    
    function cancelOrder(orderId) {
        if (!confirm('Are you sure you want to cancel this order?')) return;
        
        fetch(`/admin/orders/${orderId}/cancel/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}',
                'Content-Type': 'application/json'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showToast('success', data.message);
                // Update UI
                const row = document.getElementById(`order-row-${orderId}`);
                if (row) {
                    const statusCell = row.querySelector('.status-badge');
                    statusCell.className = 'status-badge status-cancelled';
                    statusCell.textContent = 'Cancelled';
                    
                    // Update action buttons
                    const actionsCell = row.querySelector('.action-buttons');
                    actionsCell.innerHTML = `
                        <button class="btn-action btn-view" onclick="viewOrderDetails(${orderId})">
                            <i class="bi bi-eye"></i> View
                        </button>
                    `;
                }
                updateBadges();
            } else {
                showToast('error', data.message);
            }
        })
        .catch(error => {
            showToast('error', 'Error cancelling order');
        });
    }
    
    function updateStatus(orderId, status) {
        const statusMap = {
            'packed': 'Pack',
            'shipped': 'Ship',
            'delivered': 'Deliver'
        };
        
        if (!confirm(`Mark order as ${statusMap[status] || status}?`)) return;
        
        fetch(`/admin/orders/${orderId}/update-status/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}',
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ status: status })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showToast('success', data.message);
                // Update UI
                const row = document.getElementById(`order-row-${orderId}`);
                if (row) {
                    const statusCell = row.querySelector('.status-badge');
                    statusCell.className = `status-badge status-${status}`;
                    statusCell.textContent = status.charAt(0).toUpperCase() + status.slice(1);
                    
                    // Update action buttons based on new status
                    let buttons = '';
                    if (status === 'packed') {
                        buttons = `
                            <button class="btn-action btn-view" onclick="updateStatus(${orderId}, 'shipped')">
                                <i class="bi bi-truck"></i> Ship
                            </button>
                            <button class="btn-action btn-cancel" onclick="cancelOrder(${orderId})">
                                <i class="bi bi-x-circle"></i>
                            </button>
                            <button class="btn-action btn-view" onclick="viewOrderDetails(${orderId})">
                                <i class="bi bi-eye"></i>
                            </button>
                        `;
                    } else if (status === 'shipped') {
                        buttons = `
                            <button class="btn-action btn-confirm" onclick="updateStatus(${orderId}, 'delivered')">
                                <i class="bi bi-check2-circle"></i> Deliver
                            </button>
                            <button class="btn-action btn-cancel" onclick="cancelOrder(${orderId})">
                                <i class="bi bi-x-circle"></i>
                            </button>
                            <button class="btn-action btn-view" onclick="viewOrderDetails(${orderId})">
                                <i class="bi bi-eye"></i>
                            </button>
                        `;
                    } else if (status === 'delivered') {
                        buttons = `
                            <button class="btn-action btn-view" onclick="viewOrderDetails(${orderId})">
                                <i class="bi bi-eye"></i> View
                            </button>
                        `;
                    }
                    row.querySelector('.action-buttons').innerHTML = buttons;
                }
                updateBadges();
            } else {
                showToast('error', data.message);
            }
        })
        .catch(error => {
            showToast('error', 'Error updating order status');
        });
    }
    
    function verifyPayment(orderId) {
        if (!confirm('Verify payment for this order?')) return;
        
        // First, find the payment ID for this order
        fetch(`/admin/orders/${orderId}/details/`)
            .then(response => response.json())
            .then(data => {
                if (data.success && data.data.payment_id) {
                    // Call the payment verification endpoint
                    fetch(`/admin/payments/${data.data.payment_id}/verify/`, {
                        method: 'POST',
                        headers: {
                            'X-CSRFToken': '{{ csrf_token }}',
                            'Content-Type': 'application/json'
                        }
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            showToast('success', data.message);
                            // Update UI
                            const row = document.getElementById(`order-row-${orderId}`);
                            if (row) {
                                const paymentBadge = row.querySelector('.payment-badge');
                                paymentBadge.className = 'payment-badge payment-paid';
                                paymentBadge.textContent = paymentBadge.textContent.replace('Unpaid', 'Paid');
                                
                                // Remove verify button
                                const verifyBtn = row.querySelector('.btn-payment');
                                if (verifyBtn) verifyBtn.remove();
                            }
                            updateBadges();
                        } else {
                            showToast('error', data.message);
                        }
                    });
                } else {
                    showToast('error', 'Payment not found for this order');
                }
            })
            .catch(error => {
                showToast('error', 'Error fetching payment details');
            });
    }
    
    function loadOrders(status = 'all') {
        const tbody = document.getElementById('orders-table-body');
        tbody.innerHTML = `
            <tr>
                <td colspan="9" style="text-align: center; padding: 40px;">
                    <div class="loading-spinner" style="border-top-color: #0B2B40;"></div>
                    <p style="margin-top: 16px; color: #64748b;">Loading orders...</p>
                </td>
            </tr>
        `;
        
        fetch(`/admin/orders/status/${status}/`)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    let html = '';
                    data.orders.forEach(order => {
                        html += `
                            <tr id="order-row-${order.id}">
                                <td><span class="order-id">#ORD-${order.id}</span></td>
                                <td>
                                    <div class="customer-cell">
                                        <div class="customer-avatar">${order.customer.charAt(0).toUpperCase()}</div>
                                        <div class="customer-info">
                                            <span class="customer-name">${order.customer}</span>
                                            <span class="customer-email">${order.email}</span>
                                        </div>
                                    </div>
                                </td>
                                <td class="location-cell">
                                    <div class="location-details">
                                        <i class="bi bi-geo-alt-fill"></i>
                                        <span class="location-text">${order.location || 'No address'}</span>
                                        <div class="location-full">
                                            <strong>Address:</strong> ${order.full_address || 'Not provided'}<br>
                                            <strong>Phone:</strong> ${order.phone || 'Not provided'}
                                        </div>
                                    </div>
                                </td>
                                <td>${order.phone || 'N/A'}</td>
                                <td>${order.date}</td>
                                <td>৳${order.amount}</td>
                                <td><span class="payment-badge ${order.payment_status === 'Paid' ? 'payment-paid' : 'payment-unpaid'}">${order.payment_method}</span></td>
                                <td><span class="status-badge status-${order.order_status}">${order.order_status}</span></td>
                                <td>
                                    <div class="action-buttons">
                                        ${getActionButtons(order.id, order.order_status, order.payment_status)}
                                    </div>
                                </td>
                            </tr>
                        `;
                    });
                    
                    if (data.orders.length === 0) {
                        html = `
                            <tr>
                                <td colspan="9" style="text-align: center; padding: 40px;">
                                    <i class="bi bi-inbox" style="font-size: 48px; color: #cbd5e0;"></i>
                                    <p style="margin-top: 16px; color: #64748b;">No ${status} orders found</p>
                                </td>
                            </tr>
                        `;
                    }
                    
                    tbody.innerHTML = html;
                }
            });
    }
    
    function getActionButtons(orderId, status, paymentStatus) {
        let buttons = '';
        
        // Payment verification button for unpaid non-COD orders
        if (paymentStatus !== 'Paid') {
            buttons += `
                <button class="btn-action btn-payment" onclick="verifyPayment(${orderId})">
                    <i class="bi bi-check-circle"></i> Verify
                </button>
            `;
        }
        
        if (status === 'pending') {
            buttons += `
                <button class="btn-action btn-confirm" onclick="confirmOrder(${orderId})">
                    <i class="bi bi-check2"></i> Confirm
                </button>
                <button class="btn-action btn-cancel" onclick="cancelOrder(${orderId})">
                    <i class="bi bi-x-circle"></i> Cancel
                </button>
                <button class="btn-action btn-view" onclick="viewOrderDetails(${orderId})">
                    <i class="bi bi-eye"></i> View
                </button>
            `;
        } else if (status === 'confirmed') {
            buttons += `
                <button class="btn-action btn-view" onclick="updateStatus(${orderId}, 'packed')">
                    <i class="bi bi-box"></i> Pack
                </button>
                <button class="btn-action btn-cancel" onclick="cancelOrder(${orderId})">
                    <i class="bi bi-x-circle"></i> Cancel
                </button>
                <button class="btn-action btn-view" onclick="viewOrderDetails(${orderId})">
                    <i class="bi bi-eye"></i> View
                </button>
            `;
        } else if (status === 'packed') {
            buttons += `
                <button class="btn-action btn-view" onclick="updateStatus(${orderId}, 'shipped')">
                    <i class="bi bi-truck"></i> Ship
                </button>
                <button class="btn-action btn-cancel" onclick="cancelOrder(${orderId})">
                    <i class="bi bi-x-circle"></i> Cancel
                </button>
                <button class="btn-action btn-view" onclick="viewOrderDetails(${orderId})">
                    <i class="bi bi-eye"></i> View
                </button>
            `;
        } else if (status === 'shipped') {
            buttons += `
                <button class="btn-action btn-confirm" onclick="updateStatus(${orderId}, 'delivered')">
                    <i class="bi bi-check2-circle"></i> Deliver
                </button>
                <button class="btn-action btn-cancel" onclick="cancelOrder(${orderId})">
                    <i class="bi bi-x-circle"></i> Cancel
                </button>
                <button class="btn-action btn-view" onclick="viewOrderDetails(${orderId})">
                    <i class="bi bi-eye"></i> View
                </button>
            `;
        } else {
            buttons += `
                <button class="btn-action btn-view" onclick="viewOrderDetails(${orderId})">
                    <i class="bi bi-eye"></i> View
                </button>
            `;
        }
        
        return buttons;
    }
    
    // ===== PAYMENT MANAGEMENT =====
    function verifyPayment(paymentId, orderId) {
        if (!confirm('Verify this payment?')) return;
        
        fetch(`/admin/payments/${paymentId}/verify/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}',
                'Content-Type': 'application/json'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showToast('success', data.message);
                // Remove payment card
                const card = document.getElementById(`payment-card-${paymentId}`);
                if (card) {
                    card.remove();
                }
                // Update badges
                updateBadges();
                
                // Update order status in orders table if visible
                const orderRow = document.getElementById(`order-row-${orderId}`);
                if (orderRow) {
                    const paymentBadge = orderRow.querySelector('.payment-badge');
                    if (paymentBadge) {
                        paymentBadge.className = 'payment-badge payment-paid';
                        paymentBadge.textContent = paymentBadge.textContent;
                    }
                }
            } else {
                showToast('error', data.message);
            }
        })
        .catch(error => {
            showToast('error', 'Error verifying payment');
        });
    }
    
    // ===== PRODUCT MANAGEMENT =====
    function deleteProduct(productId) {
        if (!confirm('Are you sure you want to delete this product?')) return;
        
        fetch(`/admin/products/${productId}/delete/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}',
                'Content-Type': 'application/json'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showToast('success', data.message);
                // Remove product row
                const row = document.getElementById(`product-row-${productId}`);
                if (row) {
                    row.remove();
                }
            } else {
                showToast('error', data.message);
            }
        })
        .catch(error => {
            showToast('error', 'Error deleting product');
        });
    }
    
    function searchProducts() {
        const search = document.getElementById('product-search').value;
        const category = document.getElementById('category-filter').value;
        
        fetch(`/admin/products/?search=${search}&category=${category}`)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    let html = '';
                    data.products.forEach(product => {
                        html += `
                            <tr id="product-row-${product.id}">
                                <td>#P-${product.id}</td>
                                <td>
                                    <div style="display: flex; align-items: center; gap: 12px;">
                                        ${product.image ? 
                                            `<img src="${product.image}" style="width: 40px; height: 40px; border-radius: 10px; object-fit: cover;">` :
                                            `<div style="width: 40px; height: 40px; background: #f1f5f9; border-radius: 10px; display: flex; align-items: center; justify-content: center;">
                                                <i class="bi bi-image" style="color: #94a3b8;"></i>
                                            </div>`
                                        }
                                        ${product.name}
                                    </div>
                                </td>
                                <td>${product.category}</td>
                                <td>৳${product.final_price}</td>
                                <td>
                                    <span class="stock-badge ${product.stock_level === 'high' ? 'stock-high' : product.stock_level === 'medium' ? 'stock-medium' : 'stock-low'}">
                                        ${product.stock} units
                                    </span>
                                </td>
                                <td>
                                    ${product.status === 'Active' ? 
                                        '<span class="status-badge status-confirmed">Active</span>' : 
                                        '<span class="status-badge status-cancelled">Out of Stock</span>'}
                                </td>
                                <td>
                                    <div class="action-buttons">
                                        <button class="btn-action btn-view" onclick="editProduct(${product.id})">
                                            <i class="bi bi-pencil"></i> Edit
                                        </button>
                                        <button class="btn-action btn-cancel" onclick="deleteProduct(${product.id})">
                                            <i class="bi bi-trash"></i> Delete
                                        </button>
                                    </div>
                                </td>
                            </tr>
                        `;
                    });
                    
                    if (data.products.length === 0) {
                        html = `
                            <tr>
                                <td colspan="7" style="text-align: center; padding: 40px;">
                                    <i class="bi bi-box-seam" style="font-size: 48px; color: #cbd5e0;"></i>
                                    <p style="margin-top: 16px; color: #64748b;">No products found</p>
                                </td>
                            </tr>
                        `;
                    }
                    
                    document.getElementById('products-table-body').innerHTML = html;
                }
            });
    }
    
    // ===== UTILITY FUNCTIONS =====
    function showToast(type, message) {
        const toast = document.createElement('div');
        toast.className = `toast-notification toast-${type}`;
        toast.innerHTML = `
            <div style="display: flex; align-items: center; gap: 12px;">
                <i class="bi bi-${type === 'success' ? 'check-circle-fill' : 'exclamation-circle-fill'}" 
                   style="color: ${type === 'success' ? '#10b981' : '#ef4444'}; font-size: 20px;"></i>
                <span style="color: #1e293b; font-weight: 500;">${message}</span>
            </div>
        `;
        
        document.getElementById('toast-container').appendChild(toast);
        
        setTimeout(() => {
            toast.remove();
        }, 3000);
    }
    
    function updateBadges() {
        // Refresh page data
        location.reload();
    }
    
    function viewOrderDetails(orderId) {
        // Implement order details modal
        alert(`View details for order #ORD-${orderId}`);
    }
    
    function editProduct(productId) {
        alert(`Edit product #P-${productId}`);
    }
    
    function showAddProductModal() {
        alert('Add product functionality - Implement modal form');
    }
    
    // Filter tabs styling
    document.querySelectorAll('.filter-tab').forEach(tab => {
        tab.addEventListener('click', function() {
            document.querySelectorAll('.filter-tab').forEach(t => {
                t.style.background = '#f1f5f9';
                t.style.color = '#475569';
            });
            this.style.background = '#0B2B40';
            this.style.color = 'white';
        });
    });
</script>
{% endif %}
{% endblock %}
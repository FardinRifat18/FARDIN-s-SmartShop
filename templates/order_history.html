{% extends 'base.html' %}
{% load static %}

{% block title %}My Orders - FARDIN's SmartShop BD{% endblock %}

{% block content %}
<style>
    /* ===== PROFESSIONAL ORDER HISTORY THEME (SAME) ===== */
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap');
    
    .order-history-page {
        font-family: 'Inter', sans-serif;
        background: #f8fafc;
        min-height: 100vh;
        padding: 40px 0;
    }
    
    .order-container {
        max-width: 1280px;
        margin: 0 auto;
        padding: 0 24px;
    }
    
    /* ===== HEADER SECTION ===== */
    .orders-header {
        background: linear-gradient(135deg, #0B2B40, #1A4A5F);
        border-radius: 24px;
        padding: 32px 40px;
        margin-bottom: 32px;
        color: white;
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-wrap: wrap;
        gap: 20px;
        box-shadow: 0 15px 30px rgba(11,43,64,0.15);
    }
    
    .orders-title h1 {
        font-size: 32px;
        font-weight: 800;
        margin-bottom: 8px;
        display: flex;
        align-items: center;
        gap: 12px;
    }
    
    .orders-title h1 i {
        color: #FFEAA7;
    }
    
    .orders-title p {
        color: rgba(255,255,255,0.9);
        font-size: 15px;
        display: flex;
        align-items: center;
        gap: 8px;
    }
    
    .orders-stats {
        display: flex;
        gap: 24px;
        background: rgba(255,255,255,0.1);
        padding: 16px 28px;
        border-radius: 50px;
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255,255,255,0.2);
    }
    
    .stat-item {
        display: flex;
        align-items: center;
        gap: 12px;
    }
    
    .stat-icon {
        width: 40px;
        height: 40px;
        background: rgba(255,255,255,0.15);
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 20px;
        color: #FFEAA7;
    }
    
    .stat-info {
        display: flex;
        flex-direction: column;
    }
    
    .stat-label {
        font-size: 12px;
        color: rgba(255,255,255,0.7);
    }
    
    .stat-value {
        font-size: 20px;
        font-weight: 700;
        color: white;
    }
    
    /* ===== FILTER TABS ===== */
    .filter-section {
        background: white;
        border-radius: 20px;
        padding: 20px 24px;
        margin-bottom: 28px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-wrap: wrap;
        gap: 16px;
        box-shadow: 0 5px 20px rgba(0,0,0,0.02);
        border: 1px solid #edf2f7;
    }
    
    .filter-tabs {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
    }
    
    .filter-tab {
        padding: 10px 22px;
        border-radius: 50px;
        font-size: 14px;
        font-weight: 600;
        border: none;
        cursor: pointer;
        transition: all 0.2s;
        background: #f1f5f9;
        color: #475569;
        display: flex;
        align-items: center;
        gap: 8px;
    }
    
    .filter-tab i {
        font-size: 16px;
    }
    
    .filter-tab:hover {
        background: #e2e8f0;
    }
    
    .filter-tab.active {
        background: #0B2B40;
        color: white;
    }
    
    .filter-tab.active i {
        color: #FFEAA7;
    }
    
    .search-box {
        display: flex;
        align-items: center;
        gap: 12px;
        background: #f1f5f9;
        padding: 6px;
        border-radius: 50px;
    }
    
    .search-input {
        border: none;
        background: transparent;
        padding: 10px 18px;
        font-size: 14px;
        width: 250px;
        outline: none;
    }
    
    .search-btn {
        background: #0B2B40;
        color: white;
        border: none;
        padding: 10px 22px;
        border-radius: 50px;
        font-weight: 600;
        font-size: 14px;
        display: flex;
        align-items: center;
        gap: 8px;
        cursor: pointer;
        transition: all 0.2s;
    }
    
    .search-btn:hover {
        background: #1A4A5F;
        transform: scale(1.02);
    }
    
    /* ===== ORDERS GRID ===== */
    .orders-grid {
        display: grid;
        grid-template-columns: 1fr;
        gap: 24px;
        margin-bottom: 40px;
    }
    
    /* ===== ORDER CARD ===== */
    .order-card {
        background: white;
        border-radius: 24px;
        overflow: hidden;
        border: 1px solid #edf2f7;
        transition: all 0.3s;
        box-shadow: 0 8px 20px rgba(0,0,0,0.02);
    }
    
    .order-card:hover {
        transform: translateY(-4px);
        box-shadow: 0 20px 30px rgba(44,122,123,0.08);
        border-color: #b2d8d9;
    }
    
    .order-header {
        background: linear-gradient(to right, #f8fafc, #ffffff);
        padding: 20px 24px;
        border-bottom: 1px solid #edf2f7;
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-wrap: wrap;
        gap: 16px;
    }
    
    .order-info {
        display: flex;
        align-items: center;
        gap: 24px;
        flex-wrap: wrap;
    }
    
    .order-id {
        display: flex;
        align-items: center;
        gap: 12px;
    }
    
    .order-id-badge {
        background: #0B2B40;
        color: white;
        padding: 8px 16px;
        border-radius: 12px;
        font-weight: 700;
        font-size: 16px;
        display: flex;
        align-items: center;
        gap: 8px;
    }
    
    .order-id-badge i {
        color: #FFEAA7;
    }
    
    .order-date {
        display: flex;
        align-items: center;
        gap: 8px;
        color: #64748b;
        font-size: 14px;
    }
    
    .order-date i {
        color: #2C7A7B;
    }
    
    .order-status {
        display: flex;
        align-items: center;
        gap: 16px;
        flex-wrap: wrap;
    }
    
    .status-badge {
        padding: 8px 18px;
        border-radius: 50px;
        font-size: 13px;
        font-weight: 700;
        display: inline-flex;
        align-items: center;
        gap: 8px;
    }
    
    .status-pending {
        background: #fff3cd;
        color: #856404;
        border: 1px solid #ffeeba;
    }
    
    .status-confirmed {
        background: #d1ecf1;
        color: #0c5460;
        border: 1px solid #bee5eb;
    }
    
    .status-packed {
        background: #cce5ff;
        color: #004085;
        border: 1px solid #b8daff;
    }
    
    .status-shipped {
        background: #d4edda;
        color: #155724;
        border: 1px solid #c3e6cb;
    }
    
    .status-delivered {
        background: #d1e7dd;
        color: #0f5132;
        border: 1px solid #badbcc;
    }
    
    .status-cancelled {
        background: #f8d7da;
        color: #721c24;
        border: 1px solid #f5c6cb;
    }
    
    .payment-badge {
        padding: 6px 14px;
        border-radius: 50px;
        font-size: 12px;
        font-weight: 600;
        display: inline-flex;
        align-items: center;
        gap: 6px;
    }
    
    .payment-paid {
        background: #d1e7dd;
        color: #0f5132;
    }
    
    .payment-unpaid {
        background: #f8d7da;
        color: #721c24;
    }
    
    /* ===== CANCEL BUTTON STYLES ===== */
    .btn-cancel-order {
        background: #f8d7da;
        color: #721c24;
        border: 1px solid #f5c6cb;
        padding: 10px 20px;
        border-radius: 12px;
        font-size: 13px;
        font-weight: 600;
        display: inline-flex;
        align-items: center;
        gap: 8px;
        cursor: pointer;
        transition: all 0.2s;
        text-decoration: none;
    }
    
    .btn-cancel-order:hover {
        background: #721c24;
        color: white;
        transform: translateY(-2px);
    }
    
    .btn-cancel-order:disabled {
        opacity: 0.6;
        cursor: not-allowed;
        transform: none;
    }
    
    /* ===== CANCEL MODAL ===== */
    .cancel-modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.5);
        z-index: 9999;
        align-items: center;
        justify-content: center;
        backdrop-filter: blur(5px);
    }
    
    .modal-content {
        background: white;
        border-radius: 28px;
        padding: 40px;
        max-width: 500px;
        width: 90%;
        text-align: center;
        animation: modalSlideIn 0.3s ease;
        box-shadow: 0 25px 50px rgba(0,0,0,0.2);
    }
    
    @keyframes modalSlideIn {
        from {
            transform: translateY(-50px);
            opacity: 0;
        }
        to {
            transform: translateY(0);
            opacity: 1;
        }
    }
    
    .modal-icon {
        width: 80px;
        height: 80px;
        background: #f8d7da;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        margin: 0 auto 24px;
        color: #721c24;
        font-size: 40px;
    }
    
    .modal-title {
        font-size: 24px;
        font-weight: 800;
        color: #1e293b;
        margin-bottom: 12px;
    }
    
    .modal-text {
        color: #64748b;
        margin-bottom: 28px;
        font-size: 16px;
        line-height: 1.6;
    }
    
    .modal-actions {
        display: flex;
        gap: 16px;
        justify-content: center;
    }
    
    .btn-modal {
        padding: 14px 28px;
        border-radius: 50px;
        font-size: 15px;
        font-weight: 700;
        border: none;
        cursor: pointer;
        transition: all 0.3s;
        display: inline-flex;
        align-items: center;
        gap: 10px;
        flex: 1;
        justify-content: center;
    }
    
    .btn-modal-secondary {
        background: #f1f5f9;
        color: #475569;
    }
    
    .btn-modal-secondary:hover {
        background: #e2e8f0;
    }
    
    .btn-modal-danger {
        background: #dc3545;
        color: white;
    }
    
    .btn-modal-danger:hover {
        background: #c82333;
        transform: translateY(-2px);
        box-shadow: 0 10px 20px rgba(220,53,69,0.2);
    }
    
    .btn-modal-danger:disabled {
        opacity: 0.6;
        transform: none;
        box-shadow: none;
    }
    
    /* ===== ORDER BODY ===== */
    .order-body {
        padding: 24px;
    }
    
    .products-table {
        width: 100%;
        border-collapse: collapse;
        margin-bottom: 20px;
    }
    
    .products-table th {
        text-align: left;
        padding: 12px 8px;
        font-size: 12px;
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        color: #64748b;
        border-bottom: 2px solid #e2e8f0;
    }
    
    .products-table td {
        padding: 16px 8px;
        font-size: 14px;
        color: #334155;
        border-bottom: 1px solid #edf2f7;
    }
    
    .product-info {
        display: flex;
        align-items: center;
        gap: 16px;
    }
    
    .product-image {
        width: 60px;
        height: 60px;
        background: #f1f5f9;
        border-radius: 12px;
        object-fit: cover;
    }
    
    .product-details {
        display: flex;
        flex-direction: column;
    }
    
    .product-name {
        font-weight: 700;
        color: #0B2B40;
        margin-bottom: 4px;
    }
    
    .product-category {
        font-size: 12px;
        color: #64748b;
    }
    
    .order-summary {
        background: #f8fafc;
        border-radius: 16px;
        padding: 20px;
        margin-top: 16px;
        display: flex;
        justify-content: flex-end;
    }
    
    .summary-details {
        width: 300px;
    }
    
    .summary-row {
        display: flex;
        justify-content: space-between;
        padding: 8px 0;
        color: #475569;
        font-size: 14px;
    }
    
    .summary-row.total {
        border-top: 2px solid #e2e8f0;
        margin-top: 8px;
        padding-top: 16px;
        font-weight: 700;
        color: #0B2B40;
        font-size: 16px;
    }
    
    /* ===== ORDER FOOTER ===== */
    .order-footer {
        padding: 20px 24px;
        background: #f8fafc;
        border-top: 1px solid #edf2f7;
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-wrap: wrap;
        gap: 16px;
    }
    
    .tracking-info {
        display: flex;
        align-items: center;
        gap: 16px;
        flex-wrap: wrap;
    }
    
    .tracking-step {
        display: flex;
        align-items: center;
        gap: 8px;
        color: #64748b;
        font-size: 13px;
    }
    
    .tracking-step i {
        font-size: 18px;
    }
    
    .tracking-step.completed {
        color: #0f5132;
    }
    
    .tracking-step.active {
        color: #0B2B40;
        font-weight: 600;
    }
    
    .order-actions {
        display: flex;
        gap: 12px;
        flex-wrap: wrap;
    }
    
    .btn-action {
        padding: 10px 20px;
        border-radius: 12px;
        font-size: 13px;
        font-weight: 600;
        border: none;
        cursor: pointer;
        transition: all 0.2s;
        display: inline-flex;
        align-items: center;
        gap: 8px;
        text-decoration: none;
    }
    
    .btn-view {
        background: #0B2B40;
        color: white;
    }
    
    .btn-view:hover {
        background: #1A4A5F;
        transform: translateY(-2px);
    }
    
    .btn-track {
        background: #2C7A7B;
        color: white;
    }
    
    .btn-track:hover {
        background: #1E5F6B;
        transform: translateY(-2px);
    }
    
    .btn-pay {
        background: #FFEAA7;
        color: #0B2B40;
        font-weight: 700;
    }
    
    .btn-pay:hover {
        background: #ffd966;
        transform: translateY(-2px);
    }
    
    /* ===== EMPTY STATE ===== */
    .empty-state {
        text-align: center;
        padding: 80px 40px;
        background: white;
        border-radius: 32px;
        border: 1px solid #edf2f7;
    }
    
    .empty-icon {
        font-size: 80px;
        color: #cbd5e0;
        margin-bottom: 24px;
        animation: float 3s ease-in-out infinite;
    }
    
    @keyframes float {
        0%, 100% { transform: translateY(0); }
        50% { transform: translateY(-10px); }
    }
    
    .empty-title {
        font-size: 28px;
        font-weight: 800;
        color: #0B2B40;
        margin-bottom: 12px;
    }
    
    .empty-desc {
        color: #64748b;
        font-size: 16px;
        margin-bottom: 32px;
    }
    
    .btn-shop {
        background: linear-gradient(135deg, #0B2B40, #1A4A5F);
        color: white;
        padding: 16px 36px;
        border-radius: 50px;
        font-weight: 700;
        font-size: 16px;
        text-decoration: none;
        display: inline-flex;
        align-items: center;
        gap: 12px;
        transition: all 0.3s;
        box-shadow: 0 10px 20px rgba(11,43,64,0.2);
    }
    
    .btn-shop:hover {
        transform: translateY(-4px);
        box-shadow: 0 15px 30px rgba(11,43,64,0.3);
    }
    
    /* ===== LOADING SPINNER ===== */
    .loading-spinner {
        display: inline-block;
        width: 20px;
        height: 20px;
        border: 3px solid rgba(255,255,255,0.3);
        border-radius: 50%;
        border-top-color: white;
        animation: spin 1s ease-in-out infinite;
    }
    
    @keyframes spin {
        to { transform: rotate(360deg); }
    }
    
    /* ===== TOAST NOTIFICATION ===== */
    .toast-notification {
        position: fixed;
        top: 20px;
        right: 20px;
        background: white;
        border-radius: 16px;
        padding: 16px 24px;
        box-shadow: 0 15px 40px rgba(0,0,0,0.12);
        border-left: 6px solid;
        z-index: 9999;
        animation: slideIn 0.3s ease;
        max-width: 400px;
        display: flex;
        align-items: center;
        gap: 12px;
    }
    
    .toast-success {
        border-left-color: #10b981;
    }
    
    .toast-error {
        border-left-color: #ef4444;
    }
    
    .toast-info {
        border-left-color: #3b82f6;
    }
    
    @keyframes slideIn {
        from {
            transform: translateX(100%);
            opacity: 0;
        }
        to {
            transform: translateX(0);
            opacity: 1;
        }
    }
    
    /* ===== RESPONSIVE ===== */
    @media (max-width: 768px) {
        .orders-header {
            flex-direction: column;
            align-items: flex-start;
        }
        
        .orders-stats {
            width: 100%;
            justify-content: space-around;
        }
        
        .filter-section {
            flex-direction: column;
            align-items: stretch;
        }
        
        .search-box {
            width: 100%;
        }
        
        .search-input {
            width: 100%;
        }
        
        .order-header {
            flex-direction: column;
            align-items: flex-start;
        }
        
        .order-info {
            width: 100%;
            flex-direction: column;
            align-items: flex-start;
            gap: 12px;
        }
        
        .order-status {
            width: 100%;
            flex-direction: column;
            align-items: flex-start;
        }
        
        .order-footer {
            flex-direction: column;
            align-items: flex-start;
        }
        
        .tracking-info {
            width: 100%;
            flex-direction: column;
            align-items: flex-start;
        }
        
        .order-actions {
            width: 100%;
            flex-direction: column;
        }
        
        .btn-action, .btn-cancel-order {
            width: 100%;
            justify-content: center;
        }
        
        .modal-actions {
            flex-direction: column;
        }
    }
    
    @media (max-width: 480px) {
        .products-table {
            display: block;
            overflow-x: auto;
        }
        
        .order-total {
            width: 100%;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
    }
</style>

<div class="order-history-page">
    <div class="order-container">
        <!-- Header Section -->
        <div class="orders-header">
            <div class="orders-title">
                <h1>
                    <i class="bi bi-box-seam"></i>
                    My Orders
                </h1>
                <p>
                    <i class="bi bi-clock-history"></i>
                    Track, manage, and cancel your orders in real-time
                </p>
            </div>
            
            <div class="orders-stats">
                <div class="stat-item">
                    <div class="stat-icon">
                        <i class="bi bi-truck"></i>
                    </div>
                    <div class="stat-info">
                        <span class="stat-label">Total Orders</span>
                        <span class="stat-value" id="total-orders-count">{{ orders|length }}</span>
                    </div>
                </div>
                <div class="stat-item">
                    <div class="stat-icon">
                        <i class="bi bi-check2-circle"></i>
                    </div>
                    <div class="stat-info">
                        <span class="stat-label">Delivered</span>
                        <span class="stat-value" id="delivered-count">
                            {% with delivered=orders|dictsortreversed:"order_status" %}
                                {{ delivered|length }}
                            {% endwith %}
                        </span>
                    </div>
                </div>
                <div class="stat-item">
                    <div class="stat-icon">
                        <i class="bi bi-hourglass-split"></i>
                    </div>
                    <div class="stat-info">
                        <span class="stat-label">Pending</span>
                        <span class="stat-value" id="pending-count">
                            {% with pending=orders|dictsortreversed:"order_status" %}
                                {{ pending|length }}
                            {% endwith %}
                        </span>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Filter Section -->
        <div class="filter-section">
            <div class="filter-tabs">
                <button class="filter-tab active" onclick="filterOrders('all')">
                    <i class="bi bi-grid"></i>
                    All Orders
                </button>
                <button class="filter-tab" onclick="filterOrders('pending')">
                    <i class="bi bi-hourglass-split"></i>
                    Pending
                </button>
                <button class="filter-tab" onclick="filterOrders('confirmed')">
                    <i class="bi bi-check2"></i>
                    Confirmed
                </button>
                <button class="filter-tab" onclick="filterOrders('shipped')">
                    <i class="bi bi-truck"></i>
                    Shipped
                </button>
                <button class="filter-tab" onclick="filterOrders('delivered')">
                    <i class="bi bi-check2-circle"></i>
                    Delivered
                </button>
                <button class="filter-tab" onclick="filterOrders('cancelled')">
                    <i class="bi bi-x-circle"></i>
                    Cancelled
                </button>
            </div>
            
            <div class="search-box">
                <input type="text" class="search-input" id="orderSearch" placeholder="Search by Order ID or Product...">
                <button class="search-btn" onclick="searchOrders()">
                    <i class="bi bi-search"></i>
                    Search
                </button>
            </div>
        </div>
        
        <!-- Orders Grid -->
        <div id="orders-container">
            {% if orders %}
                {% for order in orders %}
                <div class="order-card" data-order-id="{{ order.id }}" data-order-status="{{ order.order_status }}" data-order-date="{{ order.created_at|date:'Y-m-d' }}">
                    <!-- Order Header -->
                    <div class="order-header">
                        <div class="order-info">
                            <div class="order-id">
                                <span class="order-id-badge">
                                    <i class="bi bi-receipt"></i>
                                    #ORD-{{ order.id }}
                                </span>
                                <span class="order-date">
                                    <i class="bi bi-calendar3"></i>
                                    {{ order.created_at|date:"d M Y, h:i A" }}
                                </span>
                            </div>
                            <div class="order-status">
                                <span class="status-badge status-{{ order.order_status }}">
                                    <i class="bi 
                                        {% if order.order_status == 'pending' %}bi-hourglass-split
                                        {% elif order.order_status == 'confirmed' %}bi-check2
                                        {% elif order.order_status == 'packed' %}bi-box
                                        {% elif order.order_status == 'shipped' %}bi-truck
                                        {% elif order.order_status == 'delivered' %}bi-check2-circle
                                        {% elif order.order_status == 'cancelled' %}bi-x-circle
                                        {% endif %}">
                                    </i>
                                    {{ order.get_order_status_display }}
                                </span>
                                <span class="payment-badge {% if order.payment_status %}payment-paid{% else %}payment-unpaid{% endif %}">
                                    <i class="bi {% if order.payment_status %}bi-check-circle-fill{% else %}bi-exclamation-circle-fill{% endif %}"></i>
                                    {% if order.payment_status %}Paid{% else %}Unpaid{% endif %}
                                    ({{ order.get_payment_method_display }})
                                </span>
                            </div>
                        </div>
                        <div class="order-total">
                            <span style="color: #64748b; font-size: 14px;">Total:</span>
                            <span style="font-size: 24px; font-weight: 800; color: #0B2B40; margin-left: 12px;">
                                ৳{{ order.total_price|add:60|floatformat:0 }}
                            </span>
                        </div>
                    </div>
                    
                    <!-- Order Body -->
                    <div class="order-body">
                        <table class="products-table">
                            <thead>
                                <tr>
                                    <th>Product</th>
                                    <th>Price</th>
                                    <th>Qty</th>
                                    <th>Total</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for item in order.items.all|slice:":2" %}
                                <tr>
                                    <td>
                                        <div class="product-info">
                                            {% if item.product.image %}
                                            <img src="{{ item.product.image.url }}" class="product-image" alt="{{ item.product.name }}">
                                            {% else %}
                                            <div class="product-image" style="display: flex; align-items: center; justify-content: center;">
                                                <i class="bi bi-image" style="color: #94a3b8; font-size: 24px;"></i>
                                            </div>
                                            {% endif %}
                                            <div class="product-details">
                                                <span class="product-name">{{ item.product.name|truncatechars:30 }}</span>
                                                <span class="product-category">{{ item.product.category.name }}</span>
                                            </div>
                                        </div>
                                    </td>
                                    <td>৳{{ item.price|floatformat:0 }}</td>
                                    <td>{{ item.quantity }}</td>
                                    <td><strong>৳{{ item.total|floatformat:0 }}</strong></td>
                                </tr>
                                {% endfor %}
                                {% if order.items.count > 2 %}
                                <tr>
                                    <td colspan="4" style="text-align: center; color: #64748b; padding: 12px;">
                                        <i class="bi bi-plus-circle"></i> +{{ order.items.count|add:"-2" }} more items
                                    </td>
                                </tr>
                                {% endif %}
                            </tbody>
                        </table>
                        
                        <div class="order-summary">
                            <div class="summary-details">
                                <div class="summary-row">
                                    <span>Subtotal:</span>
                                    <span>৳{{ order.total_price|floatformat:0 }}</span>
                                </div>
                                <div class="summary-row">
                                    <span>Shipping:</span>
                                    <span>৳60</span>
                                </div>
                                <div class="summary-row total">
                                    <span>Total:</span>
                                    <span>৳{{ order.total_price|add:60|floatformat:0 }}</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Order Footer -->
                    <div class="order-footer">
                        <div class="tracking-info">
                            {% if order.order_status == 'cancelled' %}
                                <div class="tracking-step" style="color: #721c24;">
                                    <i class="bi bi-x-circle-fill"></i>
                                    Order Cancelled on {{ order.updated_at|date:"d M Y" }}
                                </div>
                            {% else %}
                                <div class="tracking-step {% if order.order_status != 'pending' %}completed{% else %}active{% endif %}">
                                    <i class="bi bi-check-circle-fill"></i>
                                    Placed
                                </div>
                                <i class="bi bi-arrow-right" style="color: #cbd5e0;"></i>
                                
                                <div class="tracking-step {% if order.order_status == 'packed' or order.order_status == 'shipped' or order.order_status == 'delivered' %}completed{% elif order.order_status == 'confirmed' %}active{% endif %}">
                                    <i class="bi bi-box-fill"></i>
                                    Confirmed
                                </div>
                                <i class="bi bi-arrow-right" style="color: #cbd5e0;"></i>
                                
                                <div class="tracking-step {% if order.order_status == 'shipped' or order.order_status == 'delivered' %}completed{% elif order.order_status == 'packed' %}active{% endif %}">
                                    <i class="bi bi-truck"></i>
                                    Shipped
                                </div>
                                <i class="bi bi-arrow-right" style="color: #cbd5e0;"></i>
                                
                                <div class="tracking-step {% if order.order_status == 'delivered' %}completed{% elif order.order_status == 'shipped' %}active{% endif %}">
                                    <i class="bi bi-house-fill"></i>
                                    Delivered
                                </div>
                            {% endif %}
                        </div>
                        
                        <div class="order-actions">
                            <a href="{% url 'order_detail' order.id %}" class="btn-action btn-view">
                                <i class="bi bi-eye"></i>
                                Details
                            </a>
                            
                            {% if order.order_status == 'shipped' %}
                            <button class="btn-action btn-track" onclick="trackOrder({{ order.id }})">
                                <i class="bi bi-geo-alt"></i>
                                Track
                            </button>
                            {% endif %}
                            
                            {% if order.order_status == 'pending' and not order.payment_status and order.payment_method != 'cod' %}
                            <a href="{% url 'submit_payment' order.id %}" class="btn-action btn-pay">
                                <i class="bi bi-credit-card"></i>
                                Pay
                            </a>
                            {% endif %}
                            
                            <!-- ===== ORDER CANCEL BUTTON - USER CAN CANCEL ===== -->
                            {% if order.order_status == 'pending' or order.order_status == 'confirmed' %}
                                {% if order.payment_method == 'cod' or not order.payment_status %}
                                <button class="btn-cancel-order" onclick="showCancelModal({{ order.id }})">
                                    <i class="bi bi-x-circle"></i>
                                    Cancel Order
                                </button>
                                {% endif %}
                            {% endif %}
                            
                            {% if order.order_status == 'delivered' %}
                            <button class="btn-action" style="background: #f1f5f9; color: #334155;" onclick="writeReview({{ order.id }})">
                                <i class="bi bi-star"></i>
                                Review
                            </button>
                            {% endif %}
                        </div>
                    </div>
                </div>
                {% endfor %}
            {% else %}
                <!-- Empty State -->
                <div class="empty-state">
                    <div class="empty-icon">
                        <i class="bi bi-box-seam"></i>
                    </div>
                    <h2 class="empty-title">No Orders Yet</h2>
                    <p class="empty-desc">
                        Looks like you haven't placed any orders yet.<br>
                        Start shopping to see your orders here!
                    </p>
                    <a href="{% url 'product_list' %}" class="btn-shop">
                        <i class="bi bi-cart3"></i>
                        Start Shopping
                    </a>
                </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Cancel Order Modal -->
<div id="cancelModal" class="cancel-modal">
    <div class="modal-content">
        <div class="modal-icon">
            <i class="bi bi-exclamation-triangle-fill"></i>
        </div>
        <h3 class="modal-title">Cancel Order?</h3>
        <p class="modal-text">
            Are you sure you want to cancel this order?<br>
            This action cannot be undone and any payment will be refunded within 3-5 business days.
        </p>
        <div class="modal-actions">
            <button class="btn-modal btn-modal-secondary" onclick="hideCancelModal()">
                <i class="bi bi-x"></i>
                No, Keep Order
            </button>
            <button class="btn-modal btn-modal-danger" id="confirmCancelBtn" onclick="cancelOrder()">
                <i class="bi bi-check-circle"></i>
                Yes, Cancel Order
            </button>
        </div>
    </div>
</div>

<!-- Toast Notification Container -->
<div id="toast-container"></div>

<script>
    // ================================================
    // ===== ORDER CANCELLATION - FIXED VERSION ======
    // ================================================
    
    let currentOrderId = null;
    
    // Show Cancel Modal
    function showCancelModal(orderId) {
        currentOrderId = orderId;
        document.getElementById('cancelModal').style.display = 'flex';
    }
    
    // Hide Cancel Modal
    function hideCancelModal() {
        document.getElementById('cancelModal').style.display = 'none';
        currentOrderId = null;
    }
    
    // Cancel Order - FIXED URL
    function cancelOrder() {
        if (!currentOrderId) return;
        
        const cancelBtn = document.getElementById('confirmCancelBtn');
        const originalText = cancelBtn.innerHTML;
        
        // Show loading state
        cancelBtn.innerHTML = '<span class="loading-spinner"></span> Cancelling...';
        cancelBtn.disabled = true;
        
        // ✅ FIXED: Removed 'admin/' from URL
        fetch(`/orders/${currentOrderId}/cancel/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}',
                'Content-Type': 'application/json'
            }
        })
        .then(response => {
            if (!response.ok) {
                throw new Error('Network response was not ok');
            }
            return response.json();
        })
        .then(data => {
            if (data.success) {
                showToast('success', '✅ ' + data.message);
                
                // Update UI
                const orderCard = document.querySelector(`.order-card[data-order-id="${currentOrderId}"]`);
                if (orderCard) {
                    // Update status badge
                    const statusBadge = orderCard.querySelector('.status-badge');
                    statusBadge.className = 'status-badge status-cancelled';
                    statusBadge.innerHTML = '<i class="bi bi-x-circle"></i> Cancelled';
                    
                    // Update tracking info
                    const trackingInfo = orderCard.querySelector('.tracking-info');
                    trackingInfo.innerHTML = `
                        <div class="tracking-step" style="color: #721c24;">
                            <i class="bi bi-x-circle-fill"></i>
                            Order Cancelled
                        </div>
                    `;
                    
                    // Remove cancel button
                    const cancelButton = orderCard.querySelector('.btn-cancel-order');
                    if (cancelButton) {
                        cancelButton.remove();
                    }
                    
                    orderCard.dataset.orderStatus = 'cancelled';
                }
                
                hideCancelModal();
                showToast('success', '✅ Order cancelled successfully!');
                
                // Reload page after 2 seconds
                setTimeout(() => {
                    location.reload();
                }, 2000);
            } else {
                showToast('error', '❌ ' + data.message);
                cancelBtn.innerHTML = originalText;
                cancelBtn.disabled = false;
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showToast('error', '❌ Error cancelling order. Please try again.');
            cancelBtn.innerHTML = originalText;
            cancelBtn.disabled = false;
        });
    }
    
    // Show Toast Notification
    function showToast(type, message) {
        const toastContainer = document.getElementById('toast-container');
        if (!toastContainer) return;
        
        const toast = document.createElement('div');
        toast.className = `toast-notification toast-${type}`;
        
        let icon = '';
        let color = '';
        
        if (type === 'success') {
            icon = 'bi-check-circle-fill';
            color = '#10b981';
        } else if (type === 'error') {
            icon = 'bi-exclamation-circle-fill';
            color = '#ef4444';
        } else {
            icon = 'bi-info-circle-fill';
            color = '#3b82f6';
        }
        
        toast.innerHTML = `
            <i class="bi ${icon}" style="color: ${color}; font-size: 22px;"></i>
            <span style="color: #1e293b; font-weight: 500; flex: 1;">${message}</span>
            <button onclick="this.parentElement.remove()" style="background: none; border: none; color: #94a3b8; cursor: pointer; padding: 4px;">
                <i class="bi bi-x-lg"></i>
            </button>
        `;
        
        toastContainer.appendChild(toast);
        
        setTimeout(() => {
            if (toast.parentNode) {
                toast.remove();
            }
        }, 5000);
    }
    
    // Close modal when clicking outside
    window.onclick = function(event) {
        const modal = document.getElementById('cancelModal');
        if (event.target == modal) {
            hideCancelModal();
        }
    }
    
    // Escape key to close modal
    document.addEventListener('keydown', function(event) {
        if (event.key === 'Escape') {
            hideCancelModal();
        }
    });
</script>
{% endblock %}